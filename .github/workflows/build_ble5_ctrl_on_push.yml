name: build ble5 controller on push
run-name: ${{ github.actor }} is attempting to build ble5 controller on push to respository
on: 
  push:
    paths:
      - 'controller/build/ble5-ctr/**'
      - 'controller/build/common/**'
      - 'controller/include/**'
      - 'controller/sources/**'
jobs:
  build_on_push:
    runs-on: ubuntu-latest
    steps:
      - name: Update APT
        run: sudo apt-get update
      - name: Install ARM GNU Toolchain
        run: sudo apt-get install build-essential binutils-arm-none-eabi gcc-arm-none-eabi
      - name: Check where the ARM GNU Toolchain was installed
        run: |
          dpkg -L binutils-arm-none-eabi
          dpkg -L gcc-arm-none-eabi
      - name: Sync Repository Code
        uses: actions/checkout@v3
      - name: Dump root directory
        run: ls -all 
      - name: Build BLE5 Controller
        run: |
          export PATH=/usr/lib/gcc-arm-none-eabi/bin:/usr/lib/arm-none-eabi/bin:$PATH
          make -C controller/build/ble5-ctr/gcc
      - name: Store Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ble5-ctr-elf
          path: /home/runner/work/stacks/stacks/controller/build/ble5-ctr/gcc/bin/ble5-ctr.elf
          retention-days: 5
  download_and_test:
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with: 
          name: BLE5 Controller ELF
      - name: 'Unzip artifact'
        run: unzip ble5-ctr-elf.zip
      - name: Download on target
        run: echo "Pretending to download build on target"
      - name: Setup Test Equipment
        run: echo "Setting up test equipment for unit test"
      - name: Run Test on target
        run: echo "Running Test on Target through test equipment"
      - name: Analyze test results
        run: echo "Test Results Success" > test_result.txt
      - name: Archive test results 
        uses: actions/upload-artifact@v3
        with:
          name: BLE5 Controller Test Result
          path: test_result.txt
          retention-days: 5
